name: Discount Service CI

# When to run:
# - workflow_dispatch: manual run from the Actions tab (useful while setting things up)
# - pull_request: when a PR is opened/updated
# - push: when commits are pushed to the deployment branch
on:
  workflow_dispatch:
  pull_request:
  push:
    branches: [ "deployment" ]

jobs:
  discountservice-ci:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Quick debug (helps if paths are wrong)
      - name: Debug - show repo structure
        run: |
          echo "Current directory:"
          pwd
          echo "Repository content:"
          ls -la
          echo "src folder:"
          ls -la src || true
          echo "discountcodeservice folder (expected):"
          ls -la src/discountcodeservice || true

      # NOTE:
      # Our unit tests are inside src/discountcodeservice (main_test.go),
      # so the working-directory must point there.
      # Also we use Makefile targets so the workflow stays simple.

      - name: Lint
        working-directory: src/discountcodeservice
        run: make lint

      - name: Unit tests
        working-directory: src/discountcodeservice
        run: make test

      - name: Build
        working-directory: src/discountcodeservice
        run: make build

      - name: Docker build
        working-directory: src/discountcodeservice
        run: make docker-build

      - name: Smoke test
        working-directory: src/discountcodeservice
        run: make smoke

